{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Upload and View Document</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>
<body>

    <div class="main-content">
        {% if messages %}
        <div class="messages">
            {% for message in messages %}
            <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Upload Section -->
        <div class="section">
            <h2>Добро пожаловать в Аббревиатор!</h2>
            <div class="upload-container">
                <label for="fileInput">
                    <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 12v4a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-4"></path>
                        <polyline points="16 6 12 2 8 6"></polyline>
                        <line x1="12" y1="2" x2="12" y2="15"></line>
                    </svg>
                    <p>Перетащите в это поле файл .docx</p>
                    <p>или <span class="highlight">выберите файл</span></p>
                    <p>или <a href="{% url 'process_file_with_session' session_id=demo_session_id %}" class="highlight">запустите тест-драйв</a></p>
                </label>
                <form method="post" enctype="multipart/form-data" id="uploadForm" action="{% url 'upload_file' %}">
                    {% csrf_token %}
                    <input type="file" name="uploaded_file" id="fileInput" required style="display: none;" onchange="autoSubmitForm()">
                </form>
            </div>

            <!-- Options Section -->
            <div class="description-options">
                {% if session_id %}
                    {% with share_url=request.scheme|add:'://'|add:request.get_host|add:'/process/'|add:session_id %}
                        <input type="hidden" value="{{ share_url }}" id="shareLink">
                        <button onclick="copyShareLink()" class="btn-select-option">
                            Поделиться ссылкой на загруженный файл
                        </button>
                        <a href="{% url 'process_file_with_session' session_id=session_id %}" class="btn-select-option process-button">
                            Перейти к обработке файла
                        </a>
                    {% endwith %}
                {% endif %}
            </div>

            <!-- Loading Overlay -->    
            <div id="loading-overlay" style="display: none;">
                <div class="loading-content">
                    <div class="progress-bar">
                        <div class="progress-fill"></div>
                    </div>
                    <p>Обработка файла...</p>
                </div>
            </div>
        </div>
    </div>
<script>
    
    const uploadBox = document.querySelector('.upload-container');

    uploadBox.addEventListener('dragover', (e) => {
        e.preventDefault();
    });

    uploadBox.addEventListener('dragleave', () => {
    });

    uploadBox.addEventListener('drop', (e) => {
        e.preventDefault();
        const files = e.dataTransfer.files;
        const file = files[0];
        
        const fileName = file.name.toLowerCase();
        if (!fileName.endsWith('.docx')) {
            alert('Пожалуйста, загрузите файл формата .docx');
            return;
        }
        
        const maxSize = 1048576; // 1MB in bytes
        if (file.size > maxSize) {
            alert(`Файл слишком большой. Максимальный размер: 1MB`);
            return;
        }
        
        const fileInput = document.getElementById('fileInput');
        fileInput.files = files;
        document.getElementById('uploadForm').submit();
    });

    function checkFileSize(file) {
        const maxSize = 1048576; // 1MB in bytes
        if (file.size > maxSize) {
            alert(`Файл слишком большой. Максимальный размер: 1MB`);
            return false;
        }
        return true;
    }
    
    function copyShareLink() {
        const shareLink = document.getElementById('shareLink');
        
        if (navigator.clipboard) {
            // Use Clipboard API
            navigator.clipboard.writeText(shareLink.value || shareLink.innerText)
                .catch((err) => {
                    console.error('Failed to copy text: ', err);
                    alert('Не удалось скопировать ссылку.');
                });
        } else {
            // Fallback for older browsers
            const range = document.createRange();
            const selection = window.getSelection();
            range.selectNode(shareLink);
            selection.removeAllRanges();
            selection.addRange(range);

            try {
                const successful = document.execCommand('copy');
                if (!successful) {
                    alert('Не удалось скопировать ссылку.');
                }
            } catch (err) {
                console.error('Fallback: Unable to copy', err);
                alert('Не удалось скопировать ссылку.');
            }

            // Cleanup
            selection.removeAllRanges();
        }
    }

    function autoSubmitForm() {
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];
        
        if (!checkFileSize(file)) {
            fileInput.value = '';
            return;
        }
        
        document.getElementById('uploadForm').submit();
    }

    document.addEventListener('DOMContentLoaded', function() {
        const processButton = document.querySelector('.process-button');
        if (processButton) {
            processButton.addEventListener('click', function(e) {
                e.preventDefault();
                const loadingOverlay = document.getElementById('loading-overlay');
                const progressFill = document.querySelector('.progress-fill');

                loadingOverlay.style.display = 'flex';
                
                let progress = 0;
                const interval = setInterval(() => {
                    if (progress < 90) {
                        progress += Math.random() * 15;
                        progressFill.style.width = `${Math.min(progress, 90)}%`;
                    }
                }, 500);

                window.location.href = this.href;
            });
        }
    });
</script>

</body>
</html>
