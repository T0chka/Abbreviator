{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Processed Document</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <script>
        async function fetchWrapper(url, data = null) {
            console.log('[fetchWrapper] called with URL:', url, 'and data:', data);
            const options = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            };

            if (data) {
                options.body = JSON.stringify(data);
            }
            
            try {
                const response = await fetch(url, options);
                const contentType = response.headers.get('content-type');
                
                let responseData;
                if (contentType && contentType.includes('application/json')) {
                    responseData = await response.json();
                } else if (contentType && contentType.includes(
                    'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
                )) {
                    responseData = await response.blob();
                } else {
                    responseData = await response.text();
                }

                return {
                    ok: response.ok,
                    status: response.status,
                    data: responseData,
                    contentType
                };
            } catch (error) {
                console.error('Fetch error:', error);
                throw error;
            }
        }

        async function updateDifferenceSection() {
            console.log('[updateDifferenceSection] called');
            try {
                const response = await fetchWrapper("{% url 'update_difference_section' %}");
                if (response.ok) {
                    document.getElementById('differences-section').innerHTML = response.data;
                } else {
                    throw new Error('Update difference section failed, wrong response');
                }
            } catch (error) {
                alert(`Failed to update difference section: ${error.message}`);
            }
        }        

        async function updateAbbreviation(abb, description, action='add', orig_form='') {
            console.log('[updateAbbreviation] called with:', {
                abb, description, action, orig_form
            });
            return await fetchWrapper('{% url "update_abbreviation" %}', {
                abbreviation: abb,
                description: description,
                action: action,
                orig_form: orig_form
            });
        }

        async function useExistingForm(abbreviation, orig_form, description) {
            console.log('[useExistingForm] abbreviation:',
            abbreviation, 'orig_form:', orig_form, 'description:', description);
            try {
                const response = await updateAbbreviation(abbreviation, description, 'add', orig_form);
                console.log('[useExistingForm] response:', response);
                
                if (response.ok) {
                    document.getElementById(`mixed_item_${orig_form}`).style.display = 'none';
                    await updateDifferenceSection();
                    
                    if (response.data.mixed_chars_empty && response.data.multi_desc_empty) {
                        console.log('[useExistingForm] unmatched_abbs:', response.data.unmatched_abbs);
                        await renderUnmatchedSection(response.data.unmatched_abbs);
                    }
                } else {
                    throw new Error('Use existing description failed, wrong response');
                }
            } catch (error) {
                alert(`Failed to use existing description: ${error.message}`);
            }
        }

        async function moveToUnmatched(orig_form) {
            console.log('[moveToUnmatched] called with orig_form:', orig_form);
            try {
                const response = await fetchWrapper('{% url "move_to_unmatched" %}', {
                    abbreviation: orig_form
                });
                
                if (response.ok) {
                    document.getElementById(`mixed_item_${orig_form}`).style.display = 'none';
                    
                    if (response.data.mixed_chars_empty && response.data.multi_desc_empty) {
                        await renderUnmatchedSection(response.data.unmatched_abbs);
                    }
                } else {
                    throw new Error('Move to unmatched failed, wrong response');
                }
            } catch (error) {
                alert(`Failed to move to unmatched: ${error.message}`);
            }
        }

        function updateAbbreviationUI(abbreviation, description, action) {
            console.log('[updateAbbreviationUI] abbreviation:', abbreviation,
            'description:', description, 'action:', action);
            const descriptionText = document.getElementById(`description_text_${abbreviation}`);
            const statusIcon = document.getElementById(`status_icon_${abbreviation}`);
            const addBtn = document.getElementById(`add_btn_${abbreviation}`);
            
            if (action === 'skip') {
                descriptionText.textContent = '- (убрано)';
                statusIcon.textContent = '✗';
                addBtn.textContent = '✓ Добавить';
            } else {  // add или edit
                descriptionText.textContent = `- ${description}`;
                statusIcon.textContent = '✓';
                addBtn.textContent = '✓ Обновить';
            }
        }

        async function addAbbreviation(abb) {
            console.log('[addAbbreviation] called with abb:', abb);
            let description = document.getElementById(`desc_${abb}`).value.trim();
            if (!description) return;

            const addBtn = document.getElementById(`add_btn_${abb}`);
            const action = addBtn.innerText.includes('Добавить') ? 'add' : 'edit';
            
            try {
                await updateAbbreviation(abb, description, action);
                updateAbbreviationUI(abb, description, action);
                toggleAbbreviationContent(abb, true);
                await updateDifferenceSection();
            } catch (error) {
                alert(`Failed to add/update abbreviation: ${error.message}`);
            }
        }

        async function skipAbbreviation(abb) {
            console.log('[skipAbbreviation] called with abb:', abb);
            try {
                await updateAbbreviation(abb, '', 'skip');
                updateAbbreviationUI(abb, '', 'skip');
                toggleAbbreviationContent(abb, true);
                await updateDifferenceSection();
            } catch (error) {
                alert(`Failed to skip abbreviation: ${error.message}`);
            }
        }

        function toggleAbbreviationContent(abb, forceCollapse = false) {
            console.log('[toggleAbbreviationContent] called with abb:', abb, 'forceCollapse:', forceCollapse);
            const content = document.getElementById(`content_${abb}`);
            const toggleBtn = document.getElementById(`toggle_btn_${abb}`);
            
            if (window.getComputedStyle(content).display === 'none' && !forceCollapse) {
                content.style.display = 'block';
                toggleBtn.textContent = '▼';
            } else {
                content.style.display = 'none';
                toggleBtn.textContent = '▶';
            }
        }

        async function generateAbbreviationTable() {
            console.log('[generateAbbreviationTable] called');
            try {
                const response = await fetchWrapper("{% url 'generate_abbreviation_table' %}");
                console.log('[generateAbbreviationTable] response:', response);
                
                if (response.ok && response.data instanceof Blob) {
                    const url = window.URL.createObjectURL(response.data);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'abbreviation_table.docx';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    throw new Error('Wrong response format, not a Blob');
                }
            } catch (error) {
                alert(`Failed to generate table: ${error.message}`);
            }
        }

        async function renderUnmatchedSection(unmatchedAbbs) {
            console.log('[renderUnmatchedSection] called with unmatchedAbbs:', unmatchedAbbs);
            const mainContainer = document.querySelector('.section').parentElement;
            
            // Create the unmatched section
            const unmatchedSection = document.createElement('div');
            unmatchedSection.className = 'section';
            unmatchedSection.id = 'unmatched-section';
            
            try {
                // Fetch the partial template
                const response = await fetch("{% url 'get_unmatched_template' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ unmatched_abbs: unmatchedAbbs })
                });
                const partialHtml = await response.text();
                unmatchedSection.innerHTML = partialHtml;
                
                // Move generate button to the end
                const generateButton = document.querySelector('.generate-table-section');
                if (generateButton) {
                    generateButton.remove();
                }
                
                // Add the new section
                mainContainer.appendChild(unmatchedSection);
                
                // Add generate button after unmatched section
                if (generateButton) {
                    mainContainer.appendChild(generateButton);
                }
            } catch (error) {
                console.error('Error loading unmatched section:', error);
            }
        }
    </script>
</head>
<body>
    <div class="main-content">
        <!-- Section with differences -->
        <div id="differences-section">
            {% include 'partials/differences_section.html' %}
        </div>

    <!-- Section with mixed characters abbreviations -->
    <div class="section">
        <h2>Выбор расшифровки</h2>
        <h3>Аббревиатуры с символами из разных алфавитов (латиница/кириллица)</h3>                
        <div id="mixed-chars-section" class="abbreviation-list">
            {% for abb in mixed_chars_abbs %}
            <div class="abbreviation-item" id="mixed_item_{{ abb.original }}">
                <h4>{{ abb.highlighted|safe }}</h4>
                <div class="description-options">
                    {% for description in abb.descriptions %}
                    <button class="btn-select-option" 
                            onclick="useExistingForm(
                                '{{ abb.correct_form }}', '{{ abb.original }}', '{{ description }}'
                                )"> {{ description }}
                    </button>
                    {% endfor %}
                    <button class="btn-select-option"
                            onclick="moveToUnmatched('{{ abb.original }}')">
                        Добавить новую
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Section for Multiple Possible Descriptions -->
        <h3>Аббревиатуры с несколькими возможными расшифровками</h3>
        <div id="multiple-descriptions-section" class="abbreviation-list">
            {% for abb in multi_desc_abbs %}
            <div class="abbreviation-item" id="mixed_item_{{ abb.abbreviation }}">
                <h4> {{ abb.abbreviation }}</h4>
                <div class="description-options">
                    {% for description in abb.descriptions %}
                    <button class="btn-select-option" 
                            onclick="useExistingForm(
                                '{{ abb.abbreviation }}', '{{ abb.abbreviation }}', '{{ description }}'
                                )"> {{ description }}
                    </button>
                    {% endfor %}
                    <button class="btn-select-option"
                            onclick="moveToUnmatched('{{ abb.abbreviation }}')">
                        Добавить новую
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>


    </div>

    <!-- Section with generate table button -->
    <div class="generate-table-section">
        <button onclick="generateAbbreviationTable()" class="generate-btn">
            Сгенерировать таблицу аббревиатур
        </button>
    </div>
</body>
</html>