{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Processed Document</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <script>
        function addAbbreviation(abb) {
            let description = document.getElementById(`desc_${abb}`).value;
            if (!description.trim()) {
                document.getElementById(`status_${abb}`).innerText = '✗ Требуется описание';
                return;
            }

            const addBtn = document.getElementById(`add_btn_${abb}`);
            const action = addBtn.innerText.includes('Добавить') ? 'add' : 'edit';
            
            updateAbbreviation(abb, action)
                .then(() => {
                    // Update UI elements
                    updateAbbreviationUI(abb, {
                        buttonText: '✓ Обновить',
                        statusIcon: '✓',
                        description: `- ${description}`
                    });
                    
                    // Collapse content and update differences
                    toggleAbbreviationContent(abb, true);
                    updateDifferenceSection();
                });
        }

        function skipAbbreviation(abb) {
            updateAbbreviation(abb, 'skip')
                .then(() => {
                    // Update UI elements
                    updateAbbreviationUI(abb, {
                        buttonText: '✓ Добавить',
                        statusIcon: '✗',
                        description: '- (убрано)'
                    });
                    
                    // Clear input
                    document.getElementById(`desc_${abb}`).value = '';
                    
                    // Collapse content and update differences
                    toggleAbbreviationContent(abb, true);
                    updateDifferenceSection();
                });
        }

        function updateAbbreviation(abb, action='add') {
            let description = document.getElementById(`desc_${abb}`).value;
            let url = `{% url 'update_abbreviation' %}?abbreviation=${encodeURIComponent(abb)}&description=${encodeURIComponent(description)}&action=${action}`;

            return fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    abbreviation: abb,
                    description: description,
                    action: action
                })
            })
            .then(response => response.json());
        }

        function updateDifferenceSection() {
            fetch("{% url 'update_difference_section' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (data.html) {
                    document.getElementById('differences-section').innerHTML = data.html;
                }
            });
        }

        function toggleAbbreviationContent(abb, forceCollapse = false) {
            const content = document.getElementById(`content_${abb}`);
            const toggleBtn = document.getElementById(`toggle_btn_${abb}`);
            
            if (content.style.display === 'none' && !forceCollapse) {
                content.style.display = 'block';
                toggleBtn.textContent = '▼';
            } else {
                content.style.display = 'none';
                toggleBtn.textContent = '▶';
            }
        }

        function generateAbbreviationTable() {
            fetch("{% url 'generate_abbreviation_table' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                }
                return response.json().then(err => Promise.reject(err));
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'abbreviation_table.docx';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Произошла ошибка при генерации таблицы: ' + (error.error || 'Неизвестная ошибка'));
            });
        }

        // New helper function to reduce code duplication
        function updateAbbreviationUI(abb, {buttonText, statusIcon, description}) {
            document.getElementById(`add_btn_${abb}`).innerText = buttonText;
            document.getElementById(`status_icon_${abb}`).innerText = statusIcon;
            document.getElementById(`description_text_${abb}`).innerText = description;
        }
    </script>
</head>
<body>

    <div id="differences-section">
        {% include 'partials/differences_section.html' %}
    </div>

    <div>
        <h2>Добавление сокращений</h2>
        <div class="abbreviation-list">
            {% for abb in unmatched_abbs %}
                <div class="abbreviation-item" id="item_{{ abb.abbreviation }}">
                    <div class="abb-title" onclick="toggleAbbreviationContent('{{ abb.abbreviation }}')" style="cursor: pointer;">
                        <div class="abb-title-left">
                            <span class="status-icon" id="status_icon_{{ abb.abbreviation }}"></span>
                            <div class="abb-description">
                                <h4>{{ abb.abbreviation }}</h4>
                                <span class="description-text" id="description_text_{{ abb.abbreviation }}"></span>
                            </div>
                        </div>
                        <span class="toggle-btn" id="toggle_btn_{{ abb.abbreviation }}">▼</span>
                    </div>
                    <div class="abb-content" id="content_{{ abb.abbreviation }}">
                        <div class="input-group" id="input_group_{{ abb.abbreviation }}">
                            <input type="text" id="desc_{{ abb.abbreviation }}" placeholder="Введите расшифровку">
                            <button onclick="addAbbreviation('{{ abb.abbreviation }}')" id="add_btn_{{ abb.abbreviation }}">✓ Добавить</button>
                            <button onclick="skipAbbreviation('{{ abb.abbreviation }}')" id="skip_btn_{{ abb.abbreviation }}">✗ Убрать</button>
                        </div>
                        <div class="contexts" id="contexts_{{ abb.abbreviation }}">
                            {% for context in abb.contexts %}
                                <div class="context-item">
                                    <p>...{{ context }}...</p>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    <div class="generate-table-section">
        <button onclick="generateAbbreviationTable()" class="generate-btn">
            Сгенерировать таблицу аббревиатур
        </button>
    </div>
</body>
</html>
