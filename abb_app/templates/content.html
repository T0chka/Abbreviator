{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Processed Document</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <script>
        function addAbbreviation(abb) {
            let description = document.getElementById(`desc_${abb}`).value.trim();
            if (!description) return;

            const addBtn = document.getElementById(`add_btn_${abb}`);
            const action = addBtn.innerText.includes('Добавить') ? 'add' : 'edit';
            
            updateAbbreviation(abb, description, action)
                .then(() => {
                    updateAbbreviationUI(abb, description, action);
                    toggleAbbreviationContent(abb, true);
                    updateDifferenceSection();
                });
        }

        function skipAbbreviation(abb) {
            updateAbbreviation(abb, '', 'skip')
                .then(() => {
                    updateAbbreviationUI(abb, '', 'skip');
                    toggleAbbreviationContent(abb, true);
                    updateDifferenceSection();
                });
        }

        function updateAbbreviation(abb, description, action='add') {
            return fetch('{% url "update_abbreviation" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    abbreviation: abb,
                    description: description,
                    action: action
                })
            })
            .then(response => response.json());
        }

        function updateDifferenceSection() {
            fetch("{% url 'update_difference_section' %}", {
                method: 'POST'
            })
            .then(response => response.text())
            .then(html => {
                document.getElementById('differences-section').innerHTML = html;
            });
        }

        function toggleAbbreviationContent(abb, forceCollapse = false) {
            const content = document.getElementById(`content_${abb}`);
            const toggleBtn = document.getElementById(`toggle_btn_${abb}`);
            
            if (window.getComputedStyle(content).display === 'none' && !forceCollapse) {
                content.style.display = 'block';
                toggleBtn.textContent = '▼';
            } else {
                content.style.display = 'none';
                toggleBtn.textContent = '▶';
            }
        }

        function generateAbbreviationTable() {
            fetch("{% url 'generate_abbreviation_table' %}", {
                method: 'POST'
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => Promise.reject(err));
                }
                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'abbreviation_table.docx';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Произошла ошибка при генерации таблицы: ' + 
                      (error.error || error.message || 'Неизвестная ошибка'));
            });
        }

        // Helper function to reduce code duplication
        function updateAbbreviationUI(abbreviation, description, action) {
            const descriptionText = document.getElementById(`description_text_${abbreviation}`);
            const statusIcon = document.getElementById(`status_icon_${abbreviation}`);
            const addBtn = document.getElementById(`add_btn_${abbreviation}`);
            
            if (action === 'skip') {
                descriptionText.textContent = '- (убрано)';
                statusIcon.textContent = '✗';
                addBtn.textContent = '✓ Добавить';
            } else {  // add или edit
                descriptionText.textContent = `- ${description}`;
                statusIcon.textContent = '✓';
                addBtn.textContent = '✓ Обновить';
            }
        }

        // for mixed_chars_abbs: use existing form from dictionary
        function useExistingForm(originalAbb, form, description) {
            console.log('Using existing form:', {originalAbb, form, description});
            
            updateAbbreviation(originalAbb, description, 'add')
            .then(data => {
                console.log('Server response:', data);
                if (data.success) {
                    // Hide this abb on the UI
                    // document.getElementById(`mixed_item_${originalAbb}`).style.display = 'none';
                    updateDifferenceSection();
                    
                    // If backend says no more mixed abbreviations are left, render unmatched section
                    if (data.mixed_chars_empty) {
                        console.log('All mixed items processed, rendering unmatched section');
                        renderUnmatchedSection(data.unmatched_abbs);
                    }
                }
            })
            .catch(error => console.error('Error:', error));
        }

        // for mixed_chars_abbs: move to unmatched section
        function moveToUnmatched(originalAbb) {
            console.log('Moving to unmatched:', originalAbb);

            fetch('{% url "move_to_unmatched" %}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ abbreviation: originalAbb })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Server response:', data);
                if (data.success) {
                    // Hide this abb on the UI
                    // document.getElementById(`mixed_item_${originalAbb}`).style.display = 'none';

                    // If backend says no more mixed abbreviations are left, render unmatched section
                    if (data.mixed_chars_empty) {
                        console.log('All mixed items processed, rendering unmatched section');
                        renderUnmatchedSection(data.unmatched_abbs);
                    }
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function renderUnmatchedSection(unmatchedAbbs) {
            console.log('Rendering unmatched section with:', unmatchedAbbs);
            const mainContainer = document.querySelector('.section').parentElement;
            
            // Create the unmatched section
            const unmatchedSection = document.createElement('div');
            unmatchedSection.className = 'section';
            unmatchedSection.id = 'unmatched-section';
            
            unmatchedSection.innerHTML = `
                <h2>Добавление новых сокращений</h2>
                <div class="abbreviation-list">
                    ${unmatchedAbbs.map(abb => `
                        <div class="abbreviation-item" id="item_${abb.abbreviation}">
                            <div class="abb-title" onclick="toggleAbbreviationContent('${abb.abbreviation}')" style="cursor: pointer;">
                                <div class="abb-title-left">
                                    <span class="status-icon" id="status_icon_${abb.abbreviation}"></span>
                                    <div class="abb-description">
                                        <h4>${abb.abbreviation}</h4>
                                        <span class="description-text" id="description_text_${abb.abbreviation}"></span>
                                    </div>
                                </div>
                                <span class="toggle-btn" id="toggle_btn_${abb.abbreviation}">▼</span>
                            </div>
                            <div class="abb-content" id="content_${abb.abbreviation}">
                                <div class="input-group" id="input_group_${abb.abbreviation}">
                                    <input type="text" id="desc_${abb.abbreviation}" placeholder="Введите расшифровку">
                                    <button onclick="addAbbreviation('${abb.abbreviation}')" id="add_btn_${abb.abbreviation}">✓ Добавить</button>
                                    <button onclick="skipAbbreviation('${abb.abbreviation}')" id="skip_btn_${abb.abbreviation}">✗ Убрать</button>
                                </div>
                                <div class="contexts" id="contexts_${abb.abbreviation}">
                                    ${abb.contexts.map(context => `
                                        <div class="context-item">
                                            <p>...${context}...</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            // // Remove existing unmatched section if it exists
            // const existingUnmatched = document.getElementById('unmatched-section');
            // if (existingUnmatched) {
            //     existingUnmatched.remove();
            // }
            
            // Move generate button to the end
            const generateButton = document.querySelector('.generate-table-section');
            if (generateButton) {
                generateButton.remove();
            }
            
            // Add the new section
            mainContainer.appendChild(unmatchedSection);
            
            // Add generate button after unmatched section
            if (generateButton) {
                mainContainer.appendChild(generateButton);
            }
        }
    </script>
</head>
<body>
    <div class="main-content">
        <!-- Section with differences -->
        <div id="differences-section">
            {% include 'partials/differences_section.html' %}
        </div>

    <!-- Section with mixed characters abbreviations -->
    <div class="section">
        <h2>Выбор расшифровки</h2>
        <div id="mixed-chars-section">
            {% for abb in mixed_chars_abbs %}
            <div class="mixed-chars-item" id="mixed_item_{{ abb.original }}">
                <h4> {{ abb.original }}: смешанные символы {{ abb.highlighted }}</h4>
                <div class="matches-container">
                    {% for form, descriptions in abb.matches.items %}
                    <button class="match-btn" 
                            onclick="useExistingForm('{{ abb.original }}', '{{ form }}', '{{ descriptions.0 }}')">
                        {{ descriptions|join:', ' }}
                    </button>
                    {% endfor %}
                    <button onclick="moveToUnmatched('{{ abb.original }}')" class="add-new-btn">
                        Добавить новую
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Section with generate table button -->
    <div class="generate-table-section">
        <button onclick="generateAbbreviationTable()" class="generate-btn">
            Сгенерировать таблицу аббревиатур
        </button>
    </div>
</body>
</html>